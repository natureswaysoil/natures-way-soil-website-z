set -e

echo "ðŸ§¹ Resetting conflicted filesâ€¦"

# 1) Write a clean, valid package.json (Next 15 + ESLint 9 + Node 20)
cat > package.json <<'JSON'
{
  "name": "natureswaysoil-site",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint .",
    "format": "prettier --write ."
  },
  "dependencies": {
    "@radix-ui/react-slot": "1.0.2",
    "autoprefixer": "10.4.20",
    "class-variance-authority": "0.7.0",
    "clsx": "2.1.1",
    "lucide-react": "0.446.0",
    "next": "15.0.0",
    "postcss": "8.4.41",
    "react": "18.3.1",
    "react-dom": "18.3.1",
    "tailwind-variants": "0.2.1",
    "tailwindcss": "3.4.10",
    "@stripe/stripe-js": "^3.4.1",
    "stripe": "^16.6.0",
    "openai": "^4.58.1"
  },
  "devDependencies": {
    "@eslint/js": "9.9.0",
    "eslint": "9.33.0",
    "eslint-config-next": "15.0.0",
    "typescript": "5.5.4"
  },
  "engines": {
    "node": ">=20 <21"
  }
}
JSON

# sanity: ensure no conflict markers remain
! grep -q '<<<<<<<\|>>>>>>>' package.json || { echo "package.json still has conflict markers"; exit 1; }
node -e "JSON.parse(require('fs').readFileSync('package.json','utf8'))"

# 2) Remove Pages Router duplicates if they exist (we're using the App Router)
git rm -f pages/index.tsx pages/api/checkout.ts 2>/dev/null || true

# 3) Ensure Button exists at the new path
mkdir -p components/ui
cat > components/ui/AddToCartButton.tsx <<'TSX'
"use client"
import { useCart } from "@/lib/cart"

type AddToCartButtonProps = {
  id: string
  name: string
  amount: number
  quantity?: number
  className?: string
}

export function AddToCartButton({
  id, name, amount, quantity = 1, className
}: AddToCartButtonProps) {
  const { addItem } = useCart()
  return (
    <button
      onClick={() => addItem({ id, name, amount, quantity })}
      className={`px-4 py-2 rounded-md bg-green-600 text-white hover:bg-green-700 ${className ?? ""}`}
    >
      Add to Cart
    </button>
  )
}
export default AddToCartButton
TSX

# 4) Fix imports that still point to old button path
sed -i "s#['\"]/\\.?\\.?/\\.?\\.?/components/AddToCartButton['\"]#'@/components/ui/AddToCartButton'#g" app/products/[slug]/page.tsx 2>/dev/null || true
sed -i "s#['\"]/\\.?\\.?/components/AddToCartButton['\"]#'@/components/ui/AddToCartButton'#g" app/products/page.tsx 2>/dev/null || true
sed -i "s#['\"]/components/AddToCartButton['\"]#'@/components/ui/AddToCartButton'#g" app/products/page.tsx 2>/dev/null || true

# 5) Regenerate a clean lockfile
rm -rf node_modules package-lock.json
npm install --legacy-peer-deps

# 6) If you were mid-rebase, continue; otherwise just commit
if [ -d .git/rebase-merge ] || [ -d .git/rebase-apply ]; then
  git add -A
  git rebase --continue || true
else
  git add -A
  git commit -m "Fix conflicted package.json, regenerate lockfile, App Router only, add UI Button"
fi

# 7) Make sure the remote uses HTTPS (SSH gave you 'permission denied' earlier)
git remote set-url origin https://github.com/natureswaysoil/natures-way-soil-website-z.git

# 8) Push and set upstream (if needed)
git push -u origin main

# 9) Clean build locally (optional)
rm -rf .next
npm run build || true

echo "âœ… Repo fixed and pushed. Now redeploy on Vercel with Clear Build Cache."

